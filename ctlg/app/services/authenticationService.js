define(["constants/userBitFields"]),app.factory("authenticationService",["$controller","$cookies","$http","$log","$uibModal","$q","$rootScope","$state","$window","userBitFields",function(a,b,c,d,e,f,g,h,i,j){g.user={},g.authenticated=!1,g.session={data:null,timeStamp:Date.now()};var k,l=function(a){g.authenticated=a},m=function(a){g.session.data=a||null,g.session.timeStamp=a?Date.now():null};return{ping:function(a){if(!k||a){var b=f.defer(),e=g.session,h=e.timeStamp+3e5,i=Date.now()>h;k=b,!g.authenticated||i||a?c.get(g.settings.baseUrl+"auth/ping").success(function(a){a.user.permissions=_.buildBitfieldsObject(j.permissions,a.user.permissions),a.user.settings=_.buildBitfieldsObject(j.settings,a.user.settings),_.isObject(a.user.balance)&&(_.isNumber(a.user.balance.daily)?a.user.balance.display=a.user.balance.daily:_.isNumber(a.user.balance.weekly)?a.user.balance.display=a.user.balance.weekly:_.isNumber(a.user.balance.monthly)&&(a.user.balance.display=a.user.balance.monthly)),a.user.password={expired:a.passwordExpired},g.user=a.user,g.serviceMessages=a.serviceMessages,l(a.loggedIn),m(a),k=null,b.resolve(a)}).error(function(a){m(null),l(!1),b.reject(a),d.error("Ping Failed",a),k=null}):b.resolve(g.session.data)}return k.promise},getUser:function(){return g.user}}}]);