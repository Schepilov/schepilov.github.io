app.factory("productService",["$q","$rootScope","$httpParamSerializer","dataService",function(a,b,c,d){var e={field:"name",reverse:!1},f={},g=angular.copy(d),h=g.init("products"),i=function(a,b){if(a.attributes){var c=_.findWhere(a.attributes,{name:b});return _.isObject(c)?c.value:""}return _.isString(a[b])?a[b]:""},j=function(a,b){return String(a).toLowerCase().indexOf(String(b).toLowerCase())>=0},k=function(a,b){var c=!0;return _.each(b,function(b,d){c=c&&j(a[d],b)}),c},l=function(a,b){var c=!0;return _.each(b,function(b,d){if(c&&!_.isEmpty(b)){var e=i(a,d);c=!_.isEmpty(e)&&j(e,b)}}),c};return{setSortOrder:function(a){_.extendOwn(e,a)},getSortOrder:function(){return _.clone(e)},applySortOrder:function(a){var b=_.sortBy(a,e.field);return e.reverse?b.reverse():b},setFilter:function(a){f=_.clone(a),b.$emit("product-filter-change",_.clone(f))},getFilter:function(){return _.clone(f)},applyFilter:function(a){var b=null,c=_.pick(f,function(a,b){return $.isNumeric(b)?b>0:!_.isEmpty(b)});if(_.isEmpty(c))b=a;else{var d=_.pick(c,function(a,b){return 0===b.indexOf("_")}),e=_.pick(c,function(a,b){return["name","sku"].indexOf(b)>=0});b=_.filter(a,function(a){return k(a,e)&&l(a,d)})}return b},subscribeFilterChanges:function(a,c){var d=b.$on("product-filter-change",c);a.$on("$destroy",d)},fetch:h.fetchAll,get:function(a){return h.get(parseInt(a))},fetchAssets:function(a){return h.load(a,"assets")},flattenProductAttributes:function(a){var b=_.clone(a);return delete b.attributes,_.each(a.attributes,function(a){b[a.name]=a.value}),b},reset:function(){h.reset()}}}]),app.factory("productAttributesService",function(){return{format:function(a){var b={attributes:[],attributeSets:{}};return _.each(a,function(a){if(0===a.name.indexOf("_")){var c=a.name.split("_");switch(c.length){case 2:b.attributes.push({label:c[1],value:a.value,original:a.original?a.original:null});break;case 3:var d=c[1];_.isArray(b.attributeSets[d])||(b.attributeSets[d]=[]),b.attributeSets[d].push({label:c[2],value:a.value,original:a.original?a.original:null})}}}),_.isEmpty(b.attributeSets)&&(b.attributeSets=null),b}}});