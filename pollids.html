<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<title>Выгрузка ID пользователей ВКонтакте, принявших участие в опросе</title>
	<link rel="shortcut icon" href="https://vk.com/images/faviconnew.ico?3" />
	<link rel="apple-touch-icon" href="https://vk.com/images/safari_60.png">
	<link rel="apple-touch-icon" sizes="76x76" href="https://vk.com/images/safari_76.png">
	<link rel="apple-touch-icon" sizes="120x120" href="https://vk.com/images/safari_120.png">
	<link rel="apple-touch-icon" sizes="152x152" href="https://vk.com/images/safari_152.png">
	<link rel="stylesheet" type="text/css" href="http://yastatic.net/bootstrap/3.3.4/css/bootstrap.min.css">
	<link href='https://fonts.googleapis.com/css?family=Open+Sans:300,400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
	<style type="text/css">
		.input-group{margin-right:15px;}body{font-family:'Open Sans',Tahoma,Arial,Helvetica,sans-serif}.jumbotron{width:100%!important}.help-block{margin-top:20px}.vertical-center{min-height:100%;min-height:100vh;display:flex;align-items:center}@media (min-width:768px){.form-inline .input-group>.form-control{min-width:550px;max-width:auto}#warning{text-align:left;width:710px}}#warning,#warning2{display:none}.business_link{display:block;margin-top:50px;text-align:center}.logo{font-size:50px;color:#597DA3;margin-bottom:20px}.answer{font-weight:400}.btn-primary,h2{font-weight:300}#continue{display:block;margin:30px auto 0}.poll_name{margin-top:0;margin-bottom:15px}.name{margin-top:5px}#post_form,.answers{margin-top:25px}.answers{background:#fff;border-radius:15px;padding:25px}@media (min-width:992px){.answers{padding:45px 150px}}.btn-primary{background-color:#597DA3;border-color:#597DA3}.btn-primary.active,.btn-primary.focus,.btn-primary:active,.btn-primary:focus,.btn-primary:hover,.open>.dropdown-toggle.btn-primary{color:#fff;background-color:#4B6D94;border-color:#4B6D94}a,a:focus,a:hover{color:#597DA3;text-decoration:none}a{border-bottom:1px solid transparent;transition:border-bottom-color .3s}a:focus,a:hover{border-bottom-color:#597DA3}button:focus{outline:0!important}#point{display:none}.modal-dialog,.modal:before{display:inline-block;vertical-align:middle}.jumbotron p{font-weight:400}.modal{text-align:center;padding:0!important}.modal:before{content:'';height:100%;margin-right:-4px}.modal-dialog{text-align:left}.modal-body{padding-top:20px;padding-bottom:20px}.container .jumbotron,.container-fluid .jumbotron{border-radius:30px}.jumbotron{background-color:#F0F2F5}.modal-header{background:#F2F4F7}.modal-content{border-radius:0;box-shadow:none;-webkit-box-shadow:none}@media (max-width:992px){#start{margin-top:15px;width:100%;}#warning{width:100%}}
	</style>
	<script src="http://yastatic.net/jquery/2.1.4/jquery.min.js"></script>
	<script src="https://yastatic.net/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<script src="http://rawgit.com/eligrey/FileSaver.js/master/FileSaver.min.js" type="text/javascript"></script>
</head>
<body>
	<div class="container"><div class="row"><div class="col-xs-12 vertical-center"><div class="jumbotron"><div class="text-center"><a href="https://vk.com" target="_blank" style="border-bottom: 0;"><i class="fa fa-vk logo"></i></a><h2 class="name">Выгрузка ID участников опроса</h2></div><div id="post_form"><div class="form-inline text-center"><div class="alert alert-danger center-block" role="alert" id="warning"></div><div class="form-group"><div class="input-group input-group-lg"> <span class="input-group-addon">ID</span> <input type="text" class="form-control" placeholder="записи с опросом" aria-describedby="basic-addon1" id="post_id"> </div></div><button class="btn btn-primary btn-lg" id="start">Начать</button></div><span class="help-block text-center">Например, для записи <a href="https://vk.com/wall-2158488_511156" target="_blank">https://vk.com/wall-2158488_511156</a> её ID будет следующий: <b>-2158488_511156</b></span></div><div id="answers_form"><p class="text-center">Выберите варианты ответов, для которых нужно собрать пользователей:</p><div class="center-block answers"><div class="alert alert-danger center-block" role="alert" id="warning2"></div><div id="point"></div></div><button id="continue" class="btn btn-primary btn-lg">Собрать пользователей</button></div><div class="business_link"><a href="https://vk.com/adsnews" target="_blank">ВКонтакте для бизнеса</a> | <a href="https://vk.com/support?act=new_ads" target="_blank">Задать вопрос</a></div></div></div></div><div class="modal fade" id="Modal" tabindex="-1" role="dialog"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <h4 class="modal-title" id="myModalLabel">Перезагрузка страницы</h4> </div><div class="modal-body"> Чтобы продолжить, перезагрузите страницу. </div><div class="modal-footer"> <a href="javascript:window.location.reload(true)" class="btn btn-primary">Перезагрузить</a> </div></div></div></div>
	<script>
	$("#answers_form").hide();var access_token="f5dc0e10b6b20d6400ef8200987b9c44758f282874e25d1bac4c7934b0ca916d702fc5d1e19ad2ce979d5",user_ids=new Array,offset=0,usersamountleft=0,poll_owner=0,poll_id=0,poll_text="",answers=new Array,answers_ids=new Array,max_users_amount=0,file_string="";$("#start").click(function(){function e(e){var o="https://api.vk.com/method/wall.getById?posts="+e;return $.ajax({url:o,type:"GET",dataType:"jsonp",success:s})}function s(e){if(0!=e.response.length)if(console.log(e),0!=e.response[0].attachments.length){for(var s=0;s<e.response[0].attachments.length;s++)if("poll"==e.response[0].attachments[s].type){var n=s;console.log("GetPost"),console.log(e.response[0]);break}if(!n)return console.log("В посте нет опроса"),void $("#warning").show().html("В записи нет опроса: пожалуйта, проверьте ID.");poll_owner=e.response[0].from_id,poll_id=e.response[0].attachments[s].poll.poll_id,o(poll_owner,poll_id)}else console.log("Нет вложений"),$("#warning").show().html("Пожалуйста, проверьте ID записи.");else console.log(e),$("#warning").show().html("Пожалуйста, проверьте ID записи.")}function o(e,s){console.log(e),console.log(s);var o="https://api.vk.com/method/polls.getById?owner_id="+e+"&poll_id="+s+"&access_token="+access_token;return $.ajax({url:o,type:"GET",dataType:"jsonp",success:n})}function n(e){console.log("GetPoll"),poll_text=e.response.question;for(var s=0;s<e.response.answers.length;s++)answers[s]=e.response.answers[s],answers_ids[s]=e.response.answers[s].id,e.response.answers[s].votes>max_users_amount&&(max_users_amount=e.response.answers[s].votes);$("#point").before("<h4 class='poll_name'>"+e.response.question+"</h4>");for(var s=0;s<e.response.answers.length;s++)console.log("add answer"),$("#point").before("<div id='checkbox'><label class='answer'><input type='checkbox' id='answer' name='"+answers_ids[s]+"'> "+e.response.answers[s].text+" ("+e.response.answers[s].rate+"%, "+e.response.answers[s].votes+")</input></label></div>");$("#post_form").hide(),$("#answers_form").show(),console.log("answers: "+answers.length),$("#warning").show().html("")}var r=$("#post_id").val();e(r)}),$("#continue").click(function(){function e(){if(max_users_amount>0){var e=n.join(),s="https://api.vk.com/method/polls.getVoters?owner_id="+poll_owner+"&poll_id="+poll_id+"&count=1000&offset="+offset+"&answer_ids="+e+"&access_token="+access_token;return $.ajax({url:s,type:"GET",dataType:"jsonp",success:o})}}function s(e){for(var s=(new Date).getTime(),o=0;1e7>o&&!((new Date).getTime()-s>e);o++);}function o(o){console.log(o);for(var n=0;n<o.response.length;n++){user_ids[n]||(user_ids[n]=new Array);for(var r=0;r<o.response[n].users.length;r++)user_ids[n].push(o.response[n].users[r])}if(offset+=1e3,max_users_amount-=1e3,max_users_amount>0)s(500),e();else{for(var n=0;n<user_ids.length;n++)file_string+=user_ids.join(),console.log(n);var t=new Blob([file_string],{type:"text/plain;charset=utf-8"}),a="Список_проголосовавших.txt";saveAs(t,a),$("#Modal").modal("show")}}var n=(new Array,new Array),r=0;return $("input:checkbox:checked").each(function(e){n[e]=$(this).attr("name"),r++}),r>0?(console.log("выбрано ответов: "+n.length),void e()):(console.log("ничего не выбрано"),void $("#warning2").show().html("Не выбрано ни одного варианта ответа."))});
	</script>
</body>
</html>
